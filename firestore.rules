/**
 * @file Firestore Security Rules for eScotty Tracker - Prototyping Mode
 * @description This ruleset enforces a strict user-ownership model for charging sessions and user profiles. Each user can only access their own data. The rules are designed for rapid prototyping, focusing on authorization while relaxing data shape validation.
 * @dataStructure User profiles are at /users/{userId}. Charging sessions are at /users/{userId}/charging_sessions/{sessionId}.
 * @keySecurityDecisions User listing is disallowed. Write rules are restricted to the owner of the data. Data shape validation is minimal.
 * @denormalizationForAuthorization N/A - Path-based ownership eliminates the need for denormalization.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Controls access to user profile documents.
     * @path /users/{userId}
     * @allow (get, update, create) User can read, update, and create their own profile.
     * @deny (delete, list) Users cannot delete their own profile directly and cannot list all users.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get, update, create: if isOwner(userId);
    }

    /**
     * @description Controls access to individual charging session documents.
     * @path /users/{userId}/charging_sessions/{sessionId}
     * @allow (create) User 'user123' can create a new charging session with id = 'user123'.
     * @allow (get) User 'user123' can read a charging session with id = 'session456' if they are the owner.
     * @allow (update) User 'user123' can update a charging session with id = 'session456' if they are the owner.
     * @allow (delete) User 'user123' can delete a charging session with id = 'session456' if they are the owner.
     * @deny (create) User 'user456' cannot create a charging session under /users/user123/.
     * @deny (get) User 'user456' cannot read a charging session under /users/user123/.
     * @deny (update) User 'user456' cannot update a charging session under /users/user123/.
     * @deny (delete) User 'user456' cannot delete a charging session under /users/user123/.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/charging_sessions/{sessionId} {
      allow read, write: if isOwner(userId);
    }
  }
}
